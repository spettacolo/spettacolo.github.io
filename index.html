<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Username.bot</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <style>
    :root {
      --bg: #18001e;
      --text: #c800ff;
      --text-alt: #ffffff;
      --accent: #ffffff;
      --glow: 0 0 20px rgba(200, 0, 255, 0.6);
      --border-glow: 0 0 5px rgba(200, 0, 255, 0.3);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      line-height: 1.4;
      overflow-x: hidden;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    /* Hero Section */
    .hero {
      text-align: center;
      padding: 4rem 0;
    }
    .hero h1 {
      font-size: clamp(2.5rem, 8vw, 4rem);
      font-weight: 500;
      color: var(--text);
      margin-bottom: 1rem;
      letter-spacing: -0.02em;
      text-shadow: var(--glow);
    }
    .hero p {
      font-size: 1.1rem;
      font-weight: 300;
      color: var(--text-alt);
      margin-bottom: 2rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .hero p a {
      color: var(--accent);
      text-decoration: underline;
      transition: text-shadow 0.3s;
    }
    .hero p a:hover {
      text-shadow: var(--glow);
    }
    .btn {
      background: transparent;
      border: 1px solid var(--text);
      color: var(--text);
      padding: 1rem 2rem;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: var(--border-glow);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-radius: 50px;
    }
    .btn:hover {
      background: var(--text);
      color: var(--bg);
      box-shadow: var(--glow);
    }

    .btn-fixed {
      position: fixed;   /* Lo blocca rispetto allo schermo */
      top: 20px;         /* Distanza dall'alto */
      right: 20px;       /* Distanza da destra */
      z-index: 1000;     /* Lo tiene sopra a tutto il resto */
      padding: 0.8rem 1.5rem; /* Padding per non posizionarlo attaccato al limite dello schermo */
      background: #18001ed9;
    }

    /* Su mobile lo spostiamo leggermente o lo rimpiccioliamo se serve */
    @media (max-width: 768px) {
      .btn-fixed {
        top: 10px;
        right: 10px;
        padding: 0.6rem 1.2rem;
        font-size: 0.8rem;
      }
    }

    /* Platform Section */
    .platform {
      text-align: center;
      padding: 2rem 0;
      border-top: 1px solid rgba(200, 0, 255, 0.2);
    }
    .platform h2 {
      font-size: 1.5rem;
      font-weight: 400;
      color: var(--text);
      margin-bottom: 0.5rem;
    }
    .platform p {
      font-size: 1rem;
      color: var(--text-alt);
      margin-bottom: 1.5rem;
    }
    .connect-buttons {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .connect-buttons .btn {
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
    }
    @media (min-width: 769px) {
      .connect-buttons {
        flex-direction: row;
        justify-content: center;
      }
      .connect-buttons .btn {
        width: auto;
        margin: 0 0.5rem;
      }
    }
    /* Auctions Section */
    .auctions {
      padding: 2rem 0;
    }
    .auctions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .auctions h2 {
      font-size: 1.5rem;
      font-weight: 400;
      color: var(--text);
    }
    .sort-btn {
      background: transparent;
      border: 1px solid var(--text-alt);
      color: var(--text-alt);
      padding: 0.5rem 1rem;
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    .sort-btn:hover {
      box-shadow: var(--border-glow);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(200, 0, 255, 0.2);
    }
    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid rgba(200, 0, 255, 0.1);
      font-size: 0.95rem;
    }
    th {
      background: rgba(200, 0, 255, 0.1);
      color: var(--accent);
      font-weight: 400;
      cursor: pointer;
      user-select: none;
    }
    th:hover {
      background: rgba(200, 0, 255, 0.2);
    }
    .username {
      color: var(--text);
      text-decoration: none;
      font-weight: 500;
      word-break: break-all;
    }
    .username:hover {
      text-shadow: var(--glow);
    }
    /* Bid */
    .bid {
      display: block;
      text-align: right;
      color: var(--accent);
    }
    .bid-main {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.35rem;
      font-size: 1rem;
      font-weight: 500;
    }
    .bid-main svg {
      width: 22px;
      height: 22px;
      flex-shrink: 0;
    }
    .bid-subtitle {
      font-size: 0.8rem;
      opacity: 0.75;
      font-weight: 300;
      margin-top: 0.2rem;
    }
    .timer {
      color: var(--text-alt);
      font-weight: 300;
    }
    .ends-date {
      font-size: 0.8rem;
      opacity: 0.75;
      margin-top: 0.3rem;
      display: block;
    }
    .warning {
      color: #ff4444;
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    /* Pulsante Torna Su */
    #backToTop {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 99;
      /* background: rgba(200, 0, 255, 0.2); */
      background: rgba(24, 0, 30, 0.85);
      border: 1px solid var(--text);
      color: var(--text);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.8rem;
      cursor: pointer;
      box-shadow: var(--glow);
      transition: all 0.3s;
      align-items: center;
      justify-content: center;
    }
    #backToTop:hover {
      background: var(--text);
      color: var(--bg);
    }

    /* Responsive Mobile */
    @media (max-width: 768px) {
      body {
        padding: 0;
        margin: 0;
      }
      .container {
        padding: 1rem 0.5rem;
        max-width: 100%;
        width: 100vw;
        margin-left: calc(-50vw + 50%);
        margin-right: calc(-50vw + 50%);
      }
      .auctions-header {
        flex-direction: column;
        align-items: stretch;
        padding: 0 0.5rem;
      }
      .sort-btn {
        width: 100%;
        margin: 0 0.5rem;
      }

      /* Rimuove il bordo della tabella su mobile */
      #auctionsTable {
        display: block;
        border: none !important;
        background: transparent;
      }

      #auctionsTable thead {
        display: none;
      }
      #auctionsTable tbody tr {
        display: block;
        margin: 0 0.5rem 1.5rem 0.5rem;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(200, 0, 255, 0.2);
        border-radius: 8px;
        box-shadow: var(--border-glow);
      }
      #auctionsTable tbody td {
        display: block;
        text-align: right;
        padding: 0.4rem 0;
        border-bottom: none;
      }
      #auctionsTable tbody td::before {
        content: attr(data-label);
        float: left;
        font-weight: 500;
        color: var(--accent);
        text-transform: uppercase;
        font-size: 0.8rem;
      }
      .username {
        word-break: break-word;
        hyphens: auto;
      }
      .bid-main {
        font-size: 0.95rem;
        gap: 0.3rem;
      }
      .bid-main svg {
        width: 20px;
        height: 20px;
      }
      .bid-subtitle {
        font-size: 0.78rem;
      }

      /* Pulsante Torna Su visibile solo su mobile */
      #backToTop {
        display: none; /* Gestito da JS */
      }
    }

    @keyframes neonGlow {
      0%, 100% { box-shadow: var(--border-glow); }
      50% { box-shadow: var(--glow); }
    }
    .btn:hover, .sort-btn:hover {
      animation: neonGlow 1.5s infinite alternate;
    }
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-alt);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Hero Section -->
    <section class="hero">
      <h1>Username.bot</h1>
      <p>Qui ci andrà una bella barra di ricerca <a href="/about">Learn more</a></p>
      <button class="btn btn-fixed">Connect TON</button>
    </section>

    <!-- Platform Section -->
    <section class="platform">
      <h2>Platform</h2>
      <p><a href="/about">About</a></p>
      <p>Connect TON and Telegram to view your bids and assets</p>
      <div class="connect-buttons">
        <button class="btn">Connect TON</button>
      </div>
    </section>

    <!-- Auctions Section -->
    <section class="auctions">
      <div class="auctions-header">
        <h2>Top Auctions</h2>
        <button id="sortBtn" class="sort-btn">Price high to low</button>
      </div>
      <div id="loading" class="loading">Loading auctions...</div>
      <table id="auctionsTable" style="display: none;">
        <thead>
          <tr>
            <th data-sort="username">Username</th>
            <th data-sort="bid">Current Bid</th>
            <th data-sort="ends">Auction Ends In</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <!-- Pulsante Torna Su -->
  <button id="backToTop" title="Torna su">↑</button>

  <script>
    const TON_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M19.012 9.201L12.66 19.316a.857.857 0 0 1-1.453-.005L4.98 9.197a1.8 1.8 0 0 1-.266-.943a1.856 1.856 0 0 1 1.882-1.826h10.817c1.033 0 1.873.815 1.873 1.822a1.8 1.8 0 0 1-.274.951M6.51 8.863l4.633 7.144V8.143H6.994c-.48 0-.694.317-.484.72m6.347 7.144l4.633-7.144c.214-.403-.004-.72-.484-.72h-4.149z"/></svg>`;
    const API_URL = 'https://tonapi.io/v2/dns/auctions?tld=t.me';
    const MAX_ROWS = 500;
    const TON_TO_USD = 1.46;
    const AUCTION_DURATION = 7 * 24 * 60 * 60;
    let auctions = [];
    let sortColumn = 'bid';
    let sortAsc = false;

    // ========== TON CONNECT SETUP ==========
    /*const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://username.bot/tonconnect-manifest.json', // Sostituisci con il tuo URL
      // buttonRootId: 'ton-connect-button', // Opzionale: per pulsante ufficiale
    });*/
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://tonconnect-sdk-demo-dapp.vercel.app/tonconnect-manifest.json',
    });

    // Aggiorna i pulsanti quando cambia lo stato della connessione
    tonConnectUI.onStatusChange(wallet => {
      const buttons = document.querySelectorAll('.btn');
      buttons.forEach(btn => {
        if (btn.dataset.tonconnect === 'true') {
          if (wallet) {
            const address = wallet.account.address;
            const shortAddress = address.slice(0, 4) + '...' + address.slice(-4);
            btn.textContent = shortAddress;
          } else {
            btn.textContent = 'Connect TON';
          }
        }
      });
    });

    // Collega i pulsanti "Connect TON" a TonConnect
    document.querySelectorAll('.btn').forEach(btn => {
      if (btn.textContent.includes('Connect TON')) {
        btn.dataset.tonconnect = 'true';
        btn.addEventListener('click', async () => {
          if (tonConnectUI.connected) {
            // Se già connesso, disconnetti
            await tonConnectUI.disconnect();
          } else {
            // Apri il modal di connessione
            await tonConnectUI.openModal();
          }
        });
      }
    });
    // ========== FINE TON CONNECT SETUP ==========

    async function fetchAuctions() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error('API error');
        let data = await response.json();
        if (!Array.isArray(data)) data = data.data || [];
        auctions = data.slice(0, MAX_ROWS);
        renderTable();
        document.getElementById('auctionsTable').style.display = 'table';
        document.getElementById('loading').style.display = 'none';
      } catch (err) {
        document.getElementById('loading').textContent = 'Error loading auctions: ' + err.message;
      }
    }

    function formatTON(ton) {
      return ton.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: ton < 1 ? 3 : 0 });
    }

    function getEndsText(endTimestamp) {
      const now = Math.floor(Date.now() / 1000);
      let secondsLeft = endTimestamp - now;

      if (secondsLeft <= 0) return '<span class="warning">Closed</span>';

      const MAX_DISPLAY_TIME = 7 * 24 * 60 * 60;
      if (secondsLeft > MAX_DISPLAY_TIME) secondsLeft = MAX_DISPLAY_TIME;

      const days = Math.floor(secondsLeft / 86400);
      const hours = Math.floor((secondsLeft % 86400) / 3600);
      const minutes = Math.floor((secondsLeft % 3600) / 60);

      if (secondsLeft < 3600) {
        return `<span class="warning">${minutes} min left</span>`;
      } else if (days < 1) {
        return `<span class="warning">${hours}h ${minutes}m left</span>`;
      } else {
        let text = `${days} day${days !== 1 ? 's' : ''}`;
        if (hours > 0) text += ` ${hours}h`;
        return `${text} left`;
      }
    }

    function formatEndDate(endTimestamp) {
      const date = new Date(endTimestamp * 1000);
      return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) +
             ' at ' + date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
    }

    function renderTable() {
      const tbody = document.querySelector('#auctionsTable tbody');
      tbody.innerHTML = '';

      auctions.sort((a, b) => {
        let valA, valB;
        switch (sortColumn) {
          case 'username':
            valA = a.domain || ''; valB = b.domain || '';
            return sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
          case 'bid':
            valA = a.price || 0; valB = b.price || 0;
            return sortAsc ? valA - valB : valB - valA;
          case 'ends':
            valA = a.date || 0; valB = b.date || 0;
            return sortAsc ? valA - valB : valB - valA;
          default: return 0;
        }
      });

      auctions.forEach(item => {
        const fullDomain = item.domain || '';
        const username = fullDomain.replace('.t.me', '');
        const ton = (item.price || 0) / 1_000_000_000;
        const usd = ton * TON_TO_USD;
        
        const endsText = getEndsText(item.date);
        const endsDate = formatEndDate(item.date);

        const row = document.createElement('tr');
        row.innerHTML = `
          <td data-label="Username"><a href="/username/${username}" class="username">@${username}</a></td>
          <td data-label="Current Bid" class="bid">
            <div class="bid-main">
              ${TON_ICON_SVG}
              <span>${formatTON(ton)}</span>
            </div>
            <div class="bid-subtitle">~ $${formatTON(usd)}</div>
          </td>
          <td data-label="Ends In" class="timer">
            <div>${endsText}</div>
            <div class="ends-date">${endsDate}</div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Gestione pulsante Torna Su
    const backToTopButton = document.getElementById('backToTop');
    const triggerCardIndex = 10;

    window.addEventListener('scroll', () => {
      if (window.innerWidth > 768) {
        backToTopButton.style.display = 'none';
        return;
      }

      const cards = document.querySelectorAll('#auctionsTable tbody tr');
      if (cards.length === 0) return;

      const triggerCard = cards[triggerCardIndex];
      if (!triggerCard) return;

      const rect = triggerCard.getBoundingClientRect();
      const isPastTrigger = rect.top < window.innerHeight;

      if (isPastTrigger && window.scrollY > 300) {
        backToTopButton.style.display = 'flex';
      } else {
        backToTopButton.style.display = 'none';
      }
    });

    backToTopButton.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });

    document.querySelectorAll('th[data-sort]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.getAttribute('data-sort');
        if (sortColumn === col) sortAsc = !sortAsc;
        else { sortColumn = col; sortAsc = col !== 'bid'; }
        renderTable();
      });
    });

    document.getElementById('sortBtn').addEventListener('click', () => {
      sortColumn = 'bid';
      sortAsc = false;
      renderTable();
    });

    fetchAuctions();

    /* https://docs.ton.org/ecosystem/ton-connect/overview c'è AI integrata per chiedere info
    // Funzione per inviare una transazione
    async function sendTransaction(destinationAddress, amountInTon) {
      if (!tonConnectUI.connected) {
        alert('Connetti prima il wallet!');
        return;
      }

      try {
        const result = await tonConnectUI.sendTransaction({
          validUntil: Math.floor(Date.now() / 1000) + 300, // Valido per 5 minuti
          messages: [
            {
              address: destinationAddress,
              amount: String(amountInTon * 1_000_000_000), // Converti in nanoTON
              // payload: 'te6cc...' // Opzionale: messaggio in formato BoC
            }
          ]
        });
        console.log('Transazione inviata:', result);
      } catch (error) {
        console.error('Errore transazione:', error);
      }
    }

    // Esempio di utilizzo:
    // sendTransaction('EQB...indirizzo...', 0.1); // Invia 0.1 TON

    // per ottenere il wallet address:
    const walletAddress = tonConnectUI.account?.address;
    */
  </script>
</body>
</html>